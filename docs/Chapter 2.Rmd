---
title: "Chapter 2"
output: html_document
---

# HMM Model Derivation

## Univariate Poisson Toy Example

This section will outline the derivation of the HMM for univariate poisson observed data. 

An independent mixture model consists of $m < \infty$ component distributions with probability functions $p_i$ for $i \in {1, ... , m}$ and a “mixing distribution”. The mixing is performed by a discrete random variable $C$:

\[
 C =
  \begin{cases}
   1        & \text{with probability } \delta_1 \\
   \vdots   & \vdots \\
   i        & \text{with probability } \delta_i \\
   \vdots   & \vdots \\
   m        & \text{with probability } \delta_m = \sum_{i=1}^{m-1} \delta_i
  \end{cases}
\]

Thus $Pr(C=i)=\delta_i$ must obey $0 < \delta_i < 1$ and that  $\sum_{i=1}^m \delta_i = 1$

```{r echo=FALSE, message=FALSE}
options(digits = 3)

library(zoo)
library(xts)
library(xtable)

earthquakes = read.delim("../data/earthquakes.txt")
#head(earthquakes)

PlotTsAndDensity <- function (x) {
  par(mfrow = c(1, 2))
  plot.ts(x)
  hist(x, breaks=30, freq = F)
  lines(density(x, na.rm = T, from = 0, to = max(x, na.rm = T)))
}

PlotTsAndDensity(earthquakes$X13)

# Define model values for a 3-state mixture model 
m=3

# Functions for parameter transformation
logit <- function(vec) log(vec/(1-sum(vec)))
invlogit <- function(vec) exp(vec)/(1+sum(exp(vec)))

f <- function(PAR,data) {
  M = length(PAR)
  m = ceiling(M/2)
  LA = exp(PAR[1:m]) # transform lambdas
  DELs = invlogit(PAR[(m+1):M]) # transform deltas
  DEL = c(DELs,1-sum(DELs))
  # Equation (1.1) on p. 9
  L = DEL[1]*dpois(data,LA[1])
  for(i in 2:m){
    L = L+DEL[i]*dpois(data,LA[i])
  }
  -sum(log(L))
}

# Define starting guess for optimization
par = c(10,20,30,0.5,0.2)
PAR = par
PAR[1:3] = log(par[1:3])
PAR[4:5] = logit(par[4:5])

# Optimize using nlm
res = nlm(f,PAR, data = earthquakes$X13)
# Back transform results
lambdas = exp(res$estimate[1:3])
deltas = invlogit(res$estimate[4:5])

la1 = lambdas[1]
la2 = lambdas[2]
la3 = lambdas[3]

del = matrix(0,1,m-1)
del[1] = deltas[1]
del[2] = deltas[2]
del[3] = 1 - sum(deltas)

```

The fitted parameter values are:

$$\boldsymbol{\lambda} = \left( \lambda_1, \lambda_2 \, \lambda_3 \right) = \left( `r la1`, `r la2`, `r la3` \right)$$

$$\boldsymbol{\delta} = \left( \delta_1, \delta_2 \, \delta_3 \right) = \left( `r del[1]`, `r del[2]`, `r del[3]` \right)$$

```{r}
# Define model values for a 3-state mixture model m=3

cd = cumsum(del)

# Generate random data for a m mixture model
N = 100 # number of data points
unifvec = runif(N)
d1 = rpois(sum(unifvec < cd[1]),la1)
d2 = rpois(sum(unifvec > cd[1] & unifvec < cd[2]),la2)
d3 = rpois(sum(unifvec > cd[2]),la3)
sim.x = c(d1,d2,d3) # Data vector

PlotTsAndDensity(sim.x)
PlotTsAndDensity(sample(sim.x,replace = FALSE))
```

